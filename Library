local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local TeleportService = game:GetService("TeleportService")
local CoreGui = game:GetService("CoreGui")

local LibraryConfig = {
    MenuOpen = true,
    MenuKey = Enum.KeyCode.RightControl,
    Theme = {
        Main = Color3.fromRGB(20, 20, 25),
        Container = Color3.fromRGB(30, 30, 35),
        Accent = Color3.fromRGB(0, 255, 120),
        Text = Color3.fromRGB(240, 240, 240),
        Outline = Color3.fromRGB(50, 50, 55),
        NotifyBg = Color3.fromRGB(25, 25, 30),
        BindWait = Color3.fromRGB(255, 50, 50)
    },
    FolderName = "AlphaxConfigs"
}

local Binds = {} 
local CollapsibleStates = {} 
local Library = {}
local UI_Elements = {}
local ActiveNotifications = {}

local ParentObj = gethui and gethui() or CoreGui
if ParentObj:FindFirstChild("Alphax_UI_Lib") then ParentObj.Alphax_UI_Lib:Destroy() end

local function GetNextOrder(Page) return #Page:GetChildren() end

function Library:Notify(Text, Duration)
    local Dur = Duration or 3
    local Holder = UI_Elements.NotifyHolder
    if not Holder then return end
    local NotifyFrame = Instance.new("Frame", Holder)
    NotifyFrame.Size = UDim2.new(1, 0, 0, 45); NotifyFrame.Position = UDim2.new(1, 20, 0, 20)
    NotifyFrame.BackgroundColor3 = LibraryConfig.Theme.NotifyBg
    Instance.new("UICorner", NotifyFrame).CornerRadius = UDim.new(0, 6)
    Instance.new("UIStroke", NotifyFrame).Color = LibraryConfig.Theme.Outline
    local Label = Instance.new("TextLabel", NotifyFrame); Label.Size = UDim2.new(1, -20, 1, -5); Label.Position = UDim2.new(0, 10, 0, 0)
    Label.BackgroundTransparency = 1; Label.Text = Text; Label.TextColor3 = LibraryConfig.Theme.Text; Label.Font = Enum.Font.GothamBold; Label.TextSize = 14; Label.TextXAlignment = Enum.TextXAlignment.Left
    local TimerFill = Instance.new("Frame", NotifyFrame); TimerFill.Size = UDim2.new(1, 0, 0, 2); TimerFill.Position = UDim2.new(0, 0, 1, -2); TimerFill.BackgroundColor3 = LibraryConfig.Theme.Accent
    table.insert(ActiveNotifications, 1, NotifyFrame)
    TweenService:Create(NotifyFrame, TweenInfo.new(0.5, Enum.EasingStyle.Back), {Position = UDim2.new(0, 0, 0, 20)}):Play()
    for i = 2, #ActiveNotifications do if ActiveNotifications[i].Parent then TweenService:Create(ActiveNotifications[i], TweenInfo.new(0.3), {Position = UDim2.new(0, 0, 0, 20 + ((i - 1) * 55))}):Play() end end
    TweenService:Create(TimerFill, TweenInfo.new(Dur, Enum.EasingStyle.Linear), {Size = UDim2.new(0, 0, 0, 2)}):Play()
    task.delay(Dur, function()
        if NotifyFrame.Parent then
            TweenService:Create(NotifyFrame, TweenInfo.new(0.3), {Position = UDim2.new(1, 20, 0, NotifyFrame.Position.Y.Offset)}):Play()
            task.wait(0.3); NotifyFrame:Destroy()
            for i,v in pairs(ActiveNotifications) do if v == NotifyFrame then table.remove(ActiveNotifications, i) end end
        end
    end)
end

function Library:Watermark(Name)
    local Screen = ParentObj:FindFirstChild("Alphax_UI_Lib")
    if not Screen then return end
    local Frame = Instance.new("Frame", Screen); Frame.Name = "Watermark"; Frame.BackgroundColor3 = LibraryConfig.Theme.Main; Frame.Size = UDim2.new(0, 0, 0, 25); Frame.Position = UDim2.new(0.015, 0, 0.015, 0); Frame.AutomaticSize = Enum.AutomaticSize.X
    Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 4); Instance.new("UIStroke", Frame).Color = LibraryConfig.Theme.Accent
    local Label = Instance.new("TextLabel", Frame); Label.BackgroundTransparency = 1; Label.Size = UDim2.new(0,0,1,0); Label.Position = UDim2.new(0, 10, 0, 0); Label.AutomaticSize = Enum.AutomaticSize.X; Label.Font = Enum.Font.GothamBold; Label.TextSize = 12; Label.TextColor3 = LibraryConfig.Theme.Text
    Instance.new("UIPadding", Frame).PaddingRight = UDim.new(0, 10)
    RunService.RenderStepped:Connect(function() if Frame.Parent then local fps = math.floor(1 / RunService.RenderStepped:Wait()); Label.Text = string.format("%s  |  FPS: %d", Name, fps) end end)
end

function Library:Window(TitleText)
    local Screen = Instance.new("ScreenGui", ParentObj); Screen.Name = "Alphax_UI_Lib"; Screen.ResetOnSpawn = false
    local NH = Instance.new("Frame", Screen); NH.Name="NotifyHolder"; NH.Size=UDim2.new(0,300,1,0); NH.Position=UDim2.new(1,-310,0,0); NH.BackgroundTransparency=1; UI_Elements.NotifyHolder = NH
    local Main = Instance.new("Frame", Screen); Main.Size=UDim2.new(0,550,0,500); Main.Position=UDim2.new(0.5,-275,0.5,-250); Main.BackgroundColor3=LibraryConfig.Theme.Main
    Instance.new("UICorner", Main).CornerRadius=UDim.new(0,8); Instance.new("UIStroke", Main).Color=LibraryConfig.Theme.Outline; UI_Elements.MainFrame = Main 
    local Top = Instance.new("Frame", Main); Top.Size=UDim2.new(1,0,0,45); Top.BackgroundTransparency=1
    local Title = Instance.new("TextLabel", Top); Title.Text=TitleText; Title.TextColor3=LibraryConfig.Theme.Accent; Title.Font=Enum.Font.GothamBold; Title.TextSize=18; Title.Size=UDim2.new(1,-50,1,0); Title.Position=UDim2.new(0,20,0,0); Title.TextXAlignment=Enum.TextXAlignment.Left; Title.BackgroundTransparency=1
    local Close = Instance.new("TextButton", Top); Close.Text="X"; Close.Size=UDim2.new(0,45,1,0); Close.Position=UDim2.new(1,-45,0,0); Close.BackgroundTransparency=1; Close.TextColor3=Color3.new(0.8,0.2,0.2); Close.Font=Enum.Font.GothamBold; Close.TextSize=18
    Close.MouseButton1Click:Connect(function() Main.Visible=false end)
    local TabsC = Instance.new("Frame", Main); TabsC.Size=UDim2.new(0,130,1,-55); TabsC.Position=UDim2.new(0,10,0,45); TabsC.BackgroundColor3=LibraryConfig.Theme.Container; Instance.new("UICorner", TabsC).CornerRadius=UDim.new(0,6)
    Instance.new("UIListLayout", TabsC).Padding=UDim.new(0,5); Instance.new("UIPadding", TabsC).PaddingTop=UDim.new(0,10)
    UI_Elements.Tabs=TabsC; UI_Elements.Pages=Instance.new("Frame", Main); UI_Elements.Pages.Size=UDim2.new(1,-155,1,-55); UI_Elements.Pages.Position=UDim2.new(0,150,0,45); UI_Elements.Pages.BackgroundTransparency=1; UI_Elements.Pages.Parent=Main
    
    -- Drag
    local drag, startPos; Top.InputBegan:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseButton1 then drag=i.Position; startPos=Main.Position end end)
    UserInputService.InputChanged:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseMovement and drag then local d=i.Position-drag; Main.Position=UDim2.new(startPos.X.Scale, startPos.X.Offset+d.X, startPos.Y.Scale, startPos.Y.Offset+d.Y) end end)
    UserInputService.InputEnded:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseButton1 then drag=nil end end)
    
    if UserInputService.TouchEnabled then
       local MobBtn = Instance.new("TextButton", Screen); MobBtn.Size=UDim2.new(0,50,0,50); MobBtn.Position=UDim2.new(0,20,0,50); MobBtn.BackgroundColor3=LibraryConfig.Theme.Main; MobBtn.Text="UI"; MobBtn.TextColor3=LibraryConfig.Theme.Accent
       Instance.new("UICorner", MobBtn).CornerRadius=UDim.new(0,12); Instance.new("UIStroke", MobBtn).Color=LibraryConfig.Theme.Outline
       MobBtn.MouseButton1Click:Connect(function() Main.Visible = not Main.Visible end)
    end
end

function Library:Tab(Name)
    local B = Instance.new("TextButton", UI_Elements.Tabs); B.Size=UDim2.new(0.9,0,0,35); B.BackgroundColor3=Color3.fromRGB(40,40,45); B.Text=Name; B.TextColor3=Color3.fromRGB(150,150,150); B.Font=Enum.Font.GothamBold; B.TextSize=12; Instance.new("UICorner", B).CornerRadius=UDim.new(0,4)
    local P = Instance.new("ScrollingFrame", UI_Elements.Pages); P.Size=UDim2.new(1,0,1,0); P.BackgroundTransparency=1; P.Visible=false; P.ScrollBarThickness=2
    Instance.new("UIListLayout", P).Padding=UDim.new(0,8); Instance.new("UIPadding", P).PaddingTop=UDim.new(0,5)
    B.MouseButton1Click:Connect(function() 
        for _,x in pairs(UI_Elements.Pages:GetChildren()) do x.Visible=false end; for _,x in pairs(UI_Elements.Tabs:GetChildren()) do if x:IsA("TextButton") then x.TextColor3=Color3.fromRGB(150,150,150); x.BackgroundColor3=Color3.fromRGB(40,40,45) end end
        P.Visible=true; B.TextColor3=LibraryConfig.Theme.Accent; B.BackgroundColor3=Color3.fromRGB(50,50,55) 
    end)
    return P
end

-- COMPONENTS
function Library:Label(P, T) local l=Instance.new("TextLabel",P);l.Size=UDim2.new(0.95,0,0,25);l.BackgroundTransparency=1;l.Text=T;l.TextColor3=LibraryConfig.Theme.Accent;l.Font=Enum.Font.GothamBold;l.TextSize=14;l.TextXAlignment=Enum.TextXAlignment.Left;l.LayoutOrder=GetNextOrder(P) end
function Library:Button(P, T, C) local b=Instance.new("TextButton",P);b.Size=UDim2.new(0.95,0,0,35);b.BackgroundColor3=LibraryConfig.Theme.Accent;b.Text=T;b.TextColor3=Color3.new(1,1,1);b.Font=Enum.Font.GothamBold;b.TextSize=14;Instance.new("UICorner",b).CornerRadius=UDim.new(0,4);b.MouseButton1Click:Connect(C);b.LayoutOrder=GetNextOrder(P) end
function Library:Toggle(P, T, Tab, Key, Call)
    local b=Instance.new("TextButton",P);b.Size=UDim2.new(0.95,0,0,35);b.BackgroundColor3=Color3.fromRGB(40,40,45);b.Text="";Instance.new("UICorner",b).CornerRadius=UDim.new(0,4)
    local l=Instance.new("TextLabel",b);l.Text=T;l.Size=UDim2.new(1,-40,1,0);l.Position=UDim2.new(0,10,0,0);l.BackgroundTransparency=1;l.TextColor3=LibraryConfig.Theme.Text;l.Font=Enum.Font.Gotham;l.TextSize=12;l.TextXAlignment=Enum.TextXAlignment.Left
    local i=Instance.new("Frame",b);i.Size=UDim2.new(0,20,0,20);i.Position=UDim2.new(1,-30,0.5,-10);Instance.new("UICorner",i).CornerRadius=UDim.new(0,4)
    local function Up() i.BackgroundColor3 = Tab[Key] and LibraryConfig.Theme.Accent or Color3.fromRGB(60,60,60) end; Up()
    b.MouseButton1Click:Connect(function() Tab[Key] = not Tab[Key]; Up(); if Call then Call(Tab[Key]) end end); b.LayoutOrder=GetNextOrder(P)
end
function Library:Dropdown(P, T, Opts, Tab, Key, Multi)
    local f = Instance.new("Frame", P); f.Size = UDim2.new(0.95, 0, 0, 35); f.BackgroundColor3 = Color3.fromRGB(40, 40, 45); f.ClipsDescendants = true; Instance.new("UICorner", f).CornerRadius = UDim.new(0, 4)
    local HeaderBtn = Instance.new("TextButton", f); HeaderBtn.Size = UDim2.new(1,0,0,35); HeaderBtn.BackgroundTransparency=1; HeaderBtn.Text=""
    local l = Instance.new("TextLabel", f); l.Text = T .. ": " .. (Multi and "..." or (Tab[Key] or "")); l.Size = UDim2.new(1, -35, 0, 35); l.Position = UDim2.new(0, 10, 0, 0); l.BackgroundTransparency = 1; l.TextColor3 = LibraryConfig.Theme.Text; l.Font = Enum.Font.Gotham; l.TextSize = 12; l.TextXAlignment = Enum.TextXAlignment.Left
    local lst = Instance.new("ScrollingFrame", f); lst.Size = UDim2.new(1, 0, 0, 150); lst.Position = UDim2.new(0, 0, 0, 35); lst.BackgroundColor3 = Color3.fromRGB(35, 35, 40); lst.ScrollBarThickness = 4; lst.BorderSizePixel = 0; lst.CanvasSize = UDim2.new(0,0,0,#Opts*30)
    Instance.new("UIListLayout", lst).SortOrder = Enum.SortOrder.LayoutOrder
    for _, o in pairs(Opts) do
        local ob = Instance.new("TextButton", lst); ob.Size = UDim2.new(1, 0, 0, 30); ob.BackgroundColor3 = Color3.fromRGB(35, 35, 40); ob.Text = o; ob.TextColor3 = Color3.fromRGB(200, 200, 200); ob.Font = Enum.Font.Gotham; ob.TextSize = 12; ob.BorderSizePixel = 0
        ob.MouseButton1Click:Connect(function() 
            if Multi then Tab[Key][o] = not Tab[Key][o]; ob.TextColor3 = Tab[Key][o] and LibraryConfig.Theme.Accent or Color3.fromRGB(200, 200, 200)
            else Tab[Key] = o; l.Text = T .. ": " .. o; TweenService:Create(f, TweenInfo.new(0.3), {Size = UDim2.new(0.95, 0, 0, 35)}):Play() end
        end)
    end
    HeaderBtn.MouseButton1Click:Connect(function() TweenService:Create(f, TweenInfo.new(0.3), {Size = UDim2.new(0.95, 0, 0, f.Size.Y.Offset == 35 and (35 + math.min(#Opts*30, 150)) or 35)}):Play() end)
    f.LayoutOrder=GetNextOrder(P)
end
function Library:Slider(P, T, Tab, Key, Min, Max)
    local f=Instance.new("Frame",P);f.Size=UDim2.new(0.95,0,0,45);f.BackgroundColor3=Color3.fromRGB(40,40,45);Instance.new("UICorner",f).CornerRadius=UDim.new(0,4)
    local l=Instance.new("TextLabel",f);l.Size=UDim2.new(1,0,0,20);l.Position=UDim2.new(0,10,0,0);l.BackgroundTransparency=1;l.TextColor3=LibraryConfig.Theme.Text;l.Font=Enum.Font.Gotham;l.TextSize=12;l.TextXAlignment=Enum.TextXAlignment.Left
    local b=Instance.new("TextButton",f);b.Text="";b.Size=UDim2.new(0.9,0,0,6);b.Position=UDim2.new(0.05,0,0.7,0);b.BackgroundColor3=Color3.fromRGB(20,20,20);Instance.new("UICorner",b).CornerRadius=UDim.new(1,0)
    local fill=Instance.new("Frame",b);fill.BackgroundColor3=LibraryConfig.Theme.Accent;Instance.new("UICorner",fill).CornerRadius=UDim.new(1,0)
    local function Up() local v=Tab[Key]; local p=(v-Min)/(Max-Min); fill.Size=UDim2.new(p,0,1,0); l.Text=T..": "..v end; Up()
    local drag; b.InputBegan:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseButton1 then drag=true end end)
    UserInputService.InputEnded:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseButton1 then drag=false end end)
    UserInputService.InputChanged:Connect(function(i) if drag and i.UserInputType==Enum.UserInputType.MouseMovement then local p=math.clamp((i.Position.X-b.AbsolutePosition.X)/b.AbsoluteSize.X,0,1); Tab[Key]=math.floor(Min+((Max-Min)*p)); Up() end end)
    f.LayoutOrder=GetNextOrder(P)
end
function Library:Keybind(P, T)
    local b=Instance.new("TextButton",P);b.Size=UDim2.new(0.95,0,0,35);b.BackgroundColor3=Color3.fromRGB(40,40,45);b.Text="";Instance.new("UICorner",b).CornerRadius=UDim.new(0,4)
    local l=Instance.new("TextLabel",b);l.Text=T;l.Size=UDim2.new(0.6,0,1,0);l.Position=UDim2.new(0,10,0,0);l.BackgroundTransparency=1;l.TextColor3=LibraryConfig.Theme.Text;l.Font=Enum.Font.Gotham;l.TextSize=12;l.TextXAlignment=Enum.TextXAlignment.Left
    local k=Instance.new("TextLabel",b);k.Text=LibraryConfig.MenuKey.Name;k.Size=UDim2.new(0.3,0,1,0);k.Position=UDim2.new(0.65,0,0,0);k.BackgroundTransparency=1;k.TextColor3=LibraryConfig.Theme.Accent;k.Font=Enum.Font.GothamBold;k.TextSize=12;k.TextXAlignment=Enum.TextXAlignment.Right
    b.MouseButton1Click:Connect(function() k.Text="..."; k.TextColor3=Color3.fromRGB(255,50,50); local c; c=UserInputService.InputBegan:Connect(function(i) if i.UserInputType==Enum.UserInputType.Keyboard then LibraryConfig.MenuKey=i.KeyCode; k.Text=i.KeyCode.Name; k.TextColor3=LibraryConfig.Theme.Accent; c:Disconnect() end end) end)
    b.LayoutOrder=GetNextOrder(P)
end
function Library:CollapsibleSection(P, Title, TabKey, SectionKey)
    if not CollapsibleStates[TabKey] then CollapsibleStates[TabKey] = {} end
    local sectionState = CollapsibleStates[TabKey][SectionKey]
    local MainFrame = Instance.new("Frame", P); MainFrame.Size = UDim2.new(0.95, 0, 0, 35); MainFrame.BackgroundColor3 = LibraryConfig.Theme.Container; MainFrame.ClipsDescendants = true; Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0,4)
    local HeaderButton = Instance.new("TextButton", MainFrame); HeaderButton.Size = UDim2.new(1, 0, 0, 35); HeaderButton.BackgroundTransparency = 1; HeaderButton.Text = ""
    local HeaderLabel = Instance.new("TextLabel", HeaderButton); HeaderLabel.Text = Title; HeaderLabel.Size = UDim2.new(1, -30, 1, 0); HeaderLabel.Position = UDim2.new(0, 10, 0, 0); HeaderLabel.BackgroundTransparency = 1; HeaderLabel.TextColor3 = LibraryConfig.Theme.Accent; HeaderLabel.Font = Enum.Font.GothamBold; HeaderLabel.TextSize = 14; HeaderLabel.TextXAlignment = Enum.TextXAlignment.Left
    local ArrowLabel = Instance.new("TextLabel", HeaderButton); ArrowLabel.Text = sectionState and "^" or "V"; ArrowLabel.Size = UDim2.new(0, 20, 1, 0); ArrowLabel.Position = UDim2.new(1, -25, 0, 0); ArrowLabel.BackgroundTransparency = 1; ArrowLabel.TextColor3 = LibraryConfig.Theme.Accent; ArrowLabel.Font = Enum.Font.GothamBold; ArrowLabel.TextSize = 14
    local ContentFrame = Instance.new("Frame", MainFrame); ContentFrame.Size = UDim2.new(1, 0, 0, 0); ContentFrame.Position = UDim2.new(0, 0, 0, 35); ContentFrame.BackgroundTransparency = 1; ContentFrame.Visible = sectionState
    local ContentListLayout = Instance.new("UIListLayout", ContentFrame); ContentListLayout.Padding = UDim.new(0, 5); ContentListLayout.SortOrder = Enum.SortOrder.LayoutOrder
    Instance.new("UIPadding", ContentFrame).PaddingTop = UDim.new(0, 5); Instance.new("UIPadding", ContentFrame).PaddingLeft = UDim.new(0, 10)
    local function updateHeight()
        if sectionState then
            local contentHeight = 0
            for _, child in pairs(ContentFrame:GetChildren()) do if child:IsA("Frame") or child:IsA("TextButton") then contentHeight = contentHeight + child.Size.Y.Offset + ContentListLayout.Padding.Offset end end
            MainFrame.Size = UDim2.new(0.95, 0, 0, 35 + contentHeight); ArrowLabel.Text = "^"
        else MainFrame.Size = UDim2.new(0.95, 0, 0, 35); ArrowLabel.Text = "V" end
    end
    HeaderButton.MouseButton1Click:Connect(function() sectionState = not sectionState; CollapsibleStates[TabKey][SectionKey] = sectionState; ContentFrame.Visible = sectionState; updateHeight() end)
    MainFrame.LayoutOrder = GetNextOrder(P); task.spawn(function() task.wait(0.1); updateHeight() end)
    return ContentFrame, updateHeight
end

-- === NOVA FUNCAO PLAYER DROPDOWN (ADICIONAR ISSO CORRIGE O ERRO) ===
function Library:PlayerDropdown(P, T, Tab, Key, Call)
    local Players = game:GetService("Players")
    local function GetNames()
        local list = {}
        for _, p in pairs(Players:GetPlayers()) do
            if p ~= Players.LocalPlayer then table.insert(list, p.Name) end
        end
        return list
    end
    -- Usa o dropdown normal mas atualiza
    local DropFrame = Instance.new("Frame", P) -- Placeholder para manter ordem
    DropFrame.LayoutOrder = GetNextOrder(P)
    -- Recria a logica do dropdown simples aqui ou chama Library:Dropdown (mas Library:Dropdown cria frame novo)
    -- Para simplificar, vou chamar o Dropdown normal passando a lista inicial
    Library:Dropdown(P, T, GetNames(), Tab, Key, false)
    -- Nota: A atualizacao dinamica requer recriar o dropdown ou ter uma funcao .Refresh nele. 
    -- Como a versao simplificada acima nao retorna objeto, vamos deixar como estatico por enquanto para nao crashar o script.
    -- O importante agora é a função existir para o script não dar erro de nil.
end

function Library:CopyDiscord(Link) if setclipboard then setclipboard(Link); Library:Notify("Discord Copied!", 2) end end
function Library:Rejoin() game:GetService("TeleportService"):Teleport(game.PlaceId, game.Players.LocalPlayer) end
function Library:ServerHop() Library:Notify("Server Hopping...", 2) end -- Placeholder

UserInputService.InputBegan:Connect(function(input, processed)
    if processed then return end
    if input.KeyCode == LibraryConfig.MenuKey then UI_Elements.MainFrame.Visible = not UI_Elements.MainFrame.Visible end
end)

return Library
